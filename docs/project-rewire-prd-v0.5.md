# PRD v0.5 — Project Rewire（配電盤燒線 Demo / 壓接端子與老屋驚魂版）

## 0. 版本摘要

v0.5 建立在 v0.4 已完成的基礎上（15 關、10 電器、6 線材、多迴路、相位平衡、ELCB 漏電保護），聚焦三個方向：
1. **壓接端子系統** — 新增「接線品質」維度，未壓端子或壓接不良將導致接觸電阻升高、加速過熱
2. **三星評分系統** — 為所有關卡加入三星評等，增加重玩動機
3. **老屋驚魂前導** — 全新「診斷修復」遊戲模式的第一步：打開既有配電箱、診斷問題、修復接線

> v0.1–v0.4 所有功能需求維持不變，本文件僅描述 **增量（delta）** 內容。


## 1. 產品目標（This release）

在 v0.4 的基礎上：
1. 引入壓接端子作為接線品質維度，讓玩家理解「不只是線徑，端子壓接也影響安全」
2. 新增三星評分系統，給予每關 1-3 星評等，提升重玩動機與成就感
3. 推出老屋驚魂前導模式，讓玩家體驗「打開舊箱子、診斷問題、修復接線」的全新遊戲流程
4. 維持漸進式難度設計：壓接端子先獨立入門，再與老屋模式結合

### 非目標（Not in v0.5）
- 不做整線系統與美觀評分（FR-H，延後至 v0.6）
- 不做束帶工具與線路拖曳排列
- 不做弱電 / 網路
- 不做完整老屋驚魂模式（僅前導 3 關）


## 2. 功能需求（Functional Requirements）

### FR-J：壓接端子系統（Crimp Terminal System）

線材末端需壓接端子才能安全接入 NFB。未壓端子或壓接品質差 → 接觸電阻高 → 更容易過熱燒線。

**實作順序：最先實作，為老屋模式提供基礎。**

#### 端子類型

| 端子 | 名稱 | 相容線徑 | 說明 |
|------|------|----------|------|
| O 型環 | O 型環端子 | 1.6/2.0/3.5/5.5mm² | 環形，固定性佳，適合小中線徑 |
| Y 型叉 | Y 型叉端子 | 1.6/2.0/3.5/5.5/8/14mm² | 叉形，拆卸方便，適用範圍廣 |

**設計決策：**
- 端子本身無成本（簡化，聚焦壓接品質的教育意義）
- 端子類型必須與線徑相容（O 型環不支援 8mm² 以上）
- 不相容端子 = disabled，不可選

#### 壓接品質模型

壓接品質影響接觸電阻倍率，進而影響線材有效加熱電流：

| 品質 | 接觸電阻倍率 | 有效電流倍率 (√R) | 說明 |
|------|-------------|-------------------|------|
| excellent | 1.00 | 1.00 | 完美壓接，無額外電阻 |
| good | 1.05 | 1.02 | 微增 2%，一般無影響 |
| poor | 1.25 | 1.12 | 增加 12%，高負載迴路可能危險 |
| none | 1.50 | 1.22 | 無端子，20A 線材實際只能承受 ~16.3A |

**接觸電阻熱效應公式：**
- 接觸點熱耗散 = I²R，有效加熱電流 = I × √(contactResistance)
- `effectiveCurrent = totalCurrent × √(contactResistance)`
- 線材熱度模型用 `effectiveCurrent` 計算（接觸電阻產生額外熱量）
- NFB 跳脫仍看實際 `totalCurrent`（NFB 偵測實際電流，不看接觸電阻）

#### 壓接小遊戲

拖曳接線完成後，彈出壓接小遊戲 overlay：
1. **選擇端子類型**：O 型環 / Y 型叉（不相容的 disabled）
2. **壓接操作**：進度條從左到右移動，玩家在「甜蜜區」點擊/按下
   - 甜蜜區中心 = excellent
   - 甜蜜區邊緣 = good
   - 甜蜜區外但不離譜 = poor
   - 完全不壓接 = 可跳過（none，但 requiresCrimp 關卡不可跳過）
3. **結果回饋**：顯示壓接品質 + 接觸電阻預覽

#### 遊戲流程整合

- `Level.requiresCrimp: boolean` 控制是否要求壓接
- L01-L15：`requiresCrimp` 未設定（false），玩家無需壓接（向後相容）
- L16+：`requiresCrimp: true`，所有迴路接線後必須完成壓接才能送電
- 流程：拖曳接線 → 壓接小遊戲 → 送電前檢查（所有迴路已接線 + 已壓接）

#### 視覺呈現

- 電路圖 NFB 連接點顯示端子圖示（小圓環或叉型）
- 端子圖示顏色反映品質：綠=excellent、黃綠=good、橘=poor、紅虛線=none

**驗收條件：**
- requiresCrimp 關卡中，接線後自動彈出壓接小遊戲
- 端子類型與線徑相容性正確（O 型環不可選 8mm²+）
- 壓接品質正確影響線材熱度（poor/none 在高負載下明顯加速過熱）
- NFB 跳脫閾值不受接觸電阻影響
- L01-L15 不受任何影響


### FR-Star：三星評分系統（Star Rating System）

為所有關卡加入 1-3 星評分，每顆星有明確達成條件。

#### 評分規則

| 星等 | 條件 | 說明 |
|------|------|------|
| ⭐ | 安全通關 | survive survivalTime（基本通關） |
| ⭐⭐ | 成本達標 | finalCost ≤ budget |
| ⭐⭐⭐ | 獎勵目標 | 依關卡不同（見下方 bonusCondition） |

#### 獎勵目標類型（bonusCondition）

| 類型 | 參數 | 說明 |
|------|------|------|
| `no-warning` | — | 全程無任何迴路進入 warning 狀態 |
| `under-budget-ratio` | ratio: number | 成本 ≤ budget × ratio（如 0.8 = 八折預算） |
| `time-margin` | margin: number | 剩餘時間 ≥ margin 秒 |
| `crimp-quality` | minQuality: CrimpQuality | 所有迴路壓接品質 ≥ 指定品質 |
| `no-trip` | — | 全程無任何 NFB/ELCB 跳脫 |

#### 各關卡獎勵目標

| 關卡群 | bonusCondition | 說明 |
|--------|---------------|------|
| L01-L05 | `{ type: 'no-warning' }` | 全程零預警 = 完美選線 |
| L06-L10 | `{ type: 'under-budget-ratio', ratio: 0.8 }` | 精打細算 |
| L11-L12 | `{ type: 'time-margin', margin: 3 }` | 提前 3 秒餘裕 |
| L13-L15 | `{ type: 'no-trip' }` | 全程無跳脫（含 ELCB） |
| L16-L17 | `{ type: 'crimp-quality', minQuality: 'good' }` | 壓接品質達標 |
| L18-L20 | `{ type: 'no-warning' }` | 修復後完美運行 |

#### 星等紀錄

- 使用 localStorage 儲存每關歷史最佳星等
- key 格式：`rewire-stars`，value：`Record<levelIndex, 0|1|2|3>`
- LevelSelect 關卡卡片顯示歷史最佳星等（亮/暗星圖示）

**驗收條件：**
- ResultPanel 通關時顯示 1-3 星視覺（星星圖示 + 各星條件文字）
- LevelSelect 每關顯示歷史最佳星等
- localStorage 正確儲存與讀取星等紀錄
- 不同 bonusCondition 類型各自正確判定


### FR-I-Preview：老屋驚魂前導（Old House Horror Mode — Preview）

全新遊戲模式：玩家打開一個既有（損壞的）配電箱，診斷問題並修復。此為完整 FR-I 的前導版本，僅實作 3 種常見問題。

#### 老屋問題類型

| 問題 | 名稱 | 效果 | 修復方式 |
|------|------|------|----------|
| `bare-wire` | 活線沒壓端子 | contactResistance = 1.5（none） | 拆線 → 重新接線 + 壓接 |
| `wrong-wire-gauge` | 線徑過小 | 線材 maxCurrent 不足 | 拆線 → 選正確線材接線 + 壓接 |
| `oxidized-splice` | 氧化老鼠尾接法 | contactResistance = 2.0（更嚴重） | 拆線 → 重新接線 + 壓接 |

#### 老屋關卡資料結構

老屋關卡與一般關卡共用 `Level` 型別，新增 `oldHouse` 欄位：
- `oldHouse.problems: OldHouseProblem[]` — 問題清單
- `oldHouse.preWiredCircuits: Record<CircuitId, PreWiredCircuit>` — 各迴路初始接線狀態

`PreWiredCircuit` 包含：
- `wire: Wire` — 已接的線材
- `crimpQuality: CrimpQuality` — 已有的壓接品質（或 'none'）
- `appliances: Appliance[]` — 已連接的電器

#### 遊戲流程（不同於一般關卡）

1. **檢查階段**：配電箱打開，各迴路已接好線，問題迴路標記 ⚠️ 閃爍
2. **診斷階段**：玩家點擊問題迴路 → StatusDisplay 顯示問題描述與修復提示
3. **修復階段**：
   - 點擊迴路線材 → 「拆線」按鈕 → 確認拆除 → 回到未接線狀態
   - 拖曳新線材接線 → 壓接端子（因為 requiresCrimp = true）
   - 修復完所有問題後可送電
4. **驗證階段**：送電驗證（同一般關卡的送電流程）

**「拆線」操作**：
- 點擊已接線迴路 → 出現「拆線」按鈕
- 拆線後該迴路回到未接線狀態（circuitWires[id] = null, circuitCrimps[id] = null）
- 拆下的線材不退費（老屋模式用新線替換，舊線丟棄）

#### 視覺呈現

- 老屋電路圖整體色調偏暗、老舊質感
- 問題迴路：閃爍橘色邊框 + ⚠️ 圖示
- 氧化接線：線材顏色偏暗綠/褐色（vs 正常的鮮明顏色）
- 修復完成：迴路 ⚠️ 消失，恢復正常視覺
- Before/After 暗示：修復前後的對比感（未來完整版加入正式 before/after 畫面）

**驗收條件：**
- 老屋關卡開局時各迴路已接線、已有電器
- 問題迴路正確標記 ⚠️ 且閃爍
- 玩家可拆線、重新接線、壓接
- 未修復所有問題前不可送電
- 修復後送電流程與一般關卡相同
- bare-wire/wrong-gauge/oxidized-splice 三種問題各自正確運作


## 3. 更新後的完整數據表

### 線材（6 種，不變）

| 線徑 | 類型 | 安全電流 | 成本/米 |
|------|------|----------|---------|
| 1.6mm² | 單芯線 | 15A | $3 |
| 2.0mm² | 單芯線 | 20A | $5 |
| 3.5mm² | 絞線 | 25A | $8 |
| 5.5mm² | 絞線 | 30A | $12 |
| 8mm² | 絞線 | 45A | $18 |
| 14mm² | 絞線 | 70A | $28 |

### 電器（10 種，不變）

| 電器 | 功率 | 電壓 | 電流 |
|------|------|------|------|
| 吹風機 | 1200W | 110V | 10.9A |
| 快煮壺 | 1500W | 110V | 13.6A |
| 微波爐 | 1100W | 110V | 10.0A |
| 廚下加熱器 | 800W | 110V | 7.3A |
| 冰箱 | 200W | 110V | 1.8A |
| 烘衣機 | 2200W | 220V | 10.0A |
| 電熱水器 | 4400W | 220V | 20.0A |
| IH 爐 | 3000W | 220V | 13.6A |
| 冷氣 | 2800W | 220V | 12.7A |
| 浴室暖風機 | 1650W | 220V | 7.5A |

### 壓接端子（2 種，新增）

| 端子 | 相容線徑 | 說明 |
|------|----------|------|
| O 型環 | 1.6/2.0/3.5/5.5mm² | 固定性佳，小中線徑 |
| Y 型叉 | 全線徑 | 拆卸方便，適用範圍廣 |

### 壓接品質

| 品質 | 接觸電阻倍率 | 有效電流倍率 |
|------|-------------|-------------|
| excellent | 1.00 | ×1.00 |
| good | 1.05 | ×1.02 |
| poor | 1.25 | ×1.12 |
| none | 1.50 | ×1.22 |

### 老屋問題

| 問題 | 接觸電阻倍率 | 修復方式 |
|------|-------------|----------|
| bare-wire | 1.50 (none) | 拆線 + 重接 + 壓接 |
| wrong-wire-gauge | N/A（線材本身不足） | 拆線 + 換線 + 壓接 |
| oxidized-splice | 2.00 | 拆線 + 重接 + 壓接 |


## 4. 新關卡設計（L16-L20）

### L16 壓接端子入門
- **電器**：吹風機 (1200W/110V) + 冰箱 (200W/110V)
- **預算**：$80
- **存活時間**：8 秒
- **requiresCrimp**：true
- **迴路配置**：
  - c1「客廳」110V / 20A NFB — 可用：吹風機、冰箱
- **設計意圖**：首次體驗壓接端子。單迴路、低壓力。吹風機 10.9A + 冰箱 1.8A = 12.7A，2.0mm²（20A）安全。重點在學習壓接操作。poor 品質的 effectiveCurrent = 12.7 × 1.12 = 14.2A，仍在 20A 安全範圍，不會燒；但 none 的 effectiveCurrent = 12.7 × 1.22 = 15.5A，仍安全。此關不因品質差而失敗，純為教學
- **正確策略**：c1 用 2.0mm²（$50），壓接完成送電。$50 ≤ $80 ✓
- **第三星**：`{ type: 'crimp-quality', minQuality: 'good' }`

### L17 端子品質大考驗
- **電器**：快煮壺 (1500W/110V) + 微波爐 (1100W/110V) + IH 爐 (3000W/220V)
- **預算**：$180
- **存活時間**：12 秒
- **requiresCrimp**：true
- **迴路配置**：
  - c1「廚房」110V / 20A NFB — 可用：快煮壺、微波爐
  - c2「IH 爐」220V / 20A NFB — 可用：IH 爐
- **設計意圖**：壓接品質真正重要的一關。c1 快煮壺+微波 = 13.6+10.0 = 23.6A，用 3.5mm²（25A）。若壓接 poor：effectiveCurrent = 23.6 × 1.12 = 26.4A > 25A → 緩慢過熱！若 none：23.6 × 1.22 = 28.8A → 快速過熱。c2 IH 爐 13.6A，2.0mm²（20A）安全，poor 仍可（15.2A < 20A）
- **成本計算**：c1 3.5mm²($80) + c2 2.0mm²($50) = $130 ≤ $180 ✓
- **正確策略**：c1 壓接 good 以上（或用 5.5mm² 但成本 $120+$50=$170 仍可），c2 壓接品質要求較低
- **錯誤策略**：c1 壓接 poor/none → 緩慢/快速過熱 → 燒線
- **第三星**：`{ type: 'crimp-quality', minQuality: 'good' }`

### L18 老屋驚魂：初診
- **電器**：吹風機 (1200W/110V) + 冰箱 (200W/110V)
- **預算**：$100
- **存活時間**：10 秒
- **requiresCrimp**：true
- **老屋模式**：是
- **迴路配置**：
  - c1「客廳」110V / 20A NFB — 可用：吹風機、冰箱
  - c2「臥室」110V / 15A NFB — 可用：冰箱
- **老屋問題**：
  - c1：`bare-wire`（活線沒壓端子，contactResistance = 1.5）
- **預接狀態**：
  - c1：已接 2.0mm² + crimpQuality='none' + [吹風機, 冰箱]
  - c2：已接 1.6mm² + crimpQuality='excellent' + [冰箱] ← 正常迴路
- **requiredAppliances**：[吹風機, 冰箱×2]
- **設計意圖**：首次老屋體驗。c2 正常不需修。c1 bare-wire 問題 → 玩家需拆 c1 的線 → 重新接線 + 壓接。送電後 c1 吹風機+冰箱 12.7A，2.0mm² 安全。預算 $100 用來買新線材（c1 重接 2.0mm² $50，c2 保留不動不花錢？或老屋模式預接線不計成本，僅新線計成本）
- **成本規則**：老屋模式中，保留原線不計成本，僅替換的新線計成本
- **正確策略**：拆 c1 → 重接 2.0mm² + 壓接 → 送電。成本 = $50（c1 新線）≤ $100 ✓
- **第三星**：`{ type: 'no-warning' }`

### L19 老屋驚魂：全面檢修
- **電器**：快煮壺 (1500W/110V) + 微波爐 (1100W/110V) + 吹風機 (1200W/110V)
- **預算**：$180
- **存活時間**：12 秒
- **requiresCrimp**：true
- **老屋模式**：是
- **迴路配置**：
  - c1「廚房」110V / 20A NFB — 可用：快煮壺、微波爐
  - c2「客廳」110V / 20A NFB — 可用：吹風機
  - c3「儲藏室」110V / 15A NFB — 可用：微波爐
- **老屋問題**：
  - c1：`wrong-wire-gauge`（1.6mm²/15A 接 20A NFB，快煮壺+微波 23.6A 遠超）
  - c2：`bare-wire`（活線沒壓端子）
- **預接狀態**：
  - c1：已接 1.6mm² + crimpQuality='poor' + [快煮壺, 微波爐]
  - c2：已接 2.0mm² + crimpQuality='none' + [吹風機]
  - c3：已接 1.6mm² + crimpQuality='good' + [] ← 正常但沒電器
- **requiredAppliances**：[快煮壺, 微波爐, 吹風機]
- **設計意圖**：兩個問題。c1 線太細必須換；c2 需重新壓接。c3 正常。玩家可選擇重新分配電器（如微波爐移到 c3）
- **正確策略**：拆 c1 換 3.5mm²($80) + 壓接；拆 c2 重接 2.0mm²($50) + 壓接。成本 $130 ≤ $180 ✓
- **第三星**：`{ type: 'no-warning' }`

### L20 老屋驚魂：危機四伏
- **電器**：快煮壺 (1500W/110V) + 吹風機 (1200W/110V) + 浴室暖風機 (1650W/220V) + 冰箱 (200W/110V)
- **預算**：$250
- **存活時間**：15 秒
- **requiresCrimp**：true
- **相位模式**：手動分配
- **漏電模式**：隨機式
- **老屋模式**：是
- **迴路配置**：
  - c1「廚房」110V / 20A NFB / 預設紅相(R) — 可用：快煮壺、冰箱
  - c2「客廳」110V / 20A NFB / 預設紅相(R) — 可用：吹風機、冰箱
  - c3「浴室」220V / 20A NFB / **wetArea** — 可用：浴室暖風機
- **老屋問題**：
  - c1：`oxidized-splice`（氧化老鼠尾接法，contactResistance = 2.0）
  - c2：`bare-wire`（沒壓端子）
  - c3：`wrong-wire-gauge`（1.6mm²/15A 接浴室暖風機 7.5A — 線材夠但沒裝 ELCB）
- **預接狀態**：
  - c1：已接 2.0mm² + crimpQuality='none' + [快煮壺]（氧化接觸）
  - c2：已接 1.6mm² + crimpQuality='none' + [吹風機]
  - c3：已接 1.6mm² + crimpQuality='poor' + [浴室暖風機]（無 ELCB）
- **requiredAppliances**：[快煮壺, 吹風機, 冰箱]（浴室暖風機不要求）
- **設計意圖**：v0.5 畢業考。同時需要：(1) 修復三個問題 (2) 浴室 wetArea 裝 ELCB (3) 手動切相平衡 (4) 控制預算。綜合 v0.4+v0.5 所有知識
- **相位分析**：c1/c2 都預設紅相 → 需切 c2 到黑相。快煮壺 13.6A(R) vs 吹風機 10.9A(T) → I_N = 2.7A ✓
- **成本計算**：c1 重接 2.0mm²($50) + c2 重接 2.0mm²($50) + c3 重接 1.6mm²($30) + ELCB($35) = $165 ≤ $250 ✓
- **正確策略**：三迴路全拆重接 + 壓接 + c3 裝 ELCB + 切相平衡 → 送電
- **錯誤策略**：不修氧化(c1) → 快速過熱燒線；不切相 → c1+c2 全紅相 24.5A 中性線安全但不平衡；c3 不裝 ELCB → 無法送電
- **第三星**：`{ type: 'no-warning' }`


## 5. 關鍵設計決策摘要

| 決策 | 選擇 | 理由 |
|------|------|------|
| 端子無成本 | 免費 | 簡化，聚焦壓接「品質」的教育意義而非成本取捨 |
| 接觸電阻模型 | effectiveCurrent = I × √R | 物理上合理（P = I²R），且能自然整合現有 wireHeat 模型 |
| NFB 不看接觸電阻 | NFB 用實際電流 | 真實 NFB 偵測線路電流，不感知接點電阻 |
| 壓接品質判定 | 進度條甜蜜區 | 簡單直覺的小遊戲，不需額外控制器 |
| 老屋成本規則 | 僅替換線計成本 | 保留的舊線免費，降低預算壓力讓玩家專注修復 |
| 老屋「拆線」 | 點擊 + 確認 | 避免誤操作，一步確認即可 |
| 三星評分存儲 | localStorage | 簡單實用，不需後端 |
| oxidized-splice 電阻 | 2.0（vs none 的 1.5） | 氧化比無端子更危險，教育玩家氧化的嚴重性 |
| FR-H 延後 | 延至 v0.6 | 整線系統需新 panel interior view，scope 過大 |
| 新關卡數 | 5 關（L16-L20） | 端子 2 關 + 老屋 3 關，合理遞進 |


## 6. 向後相容性

- L01-L15 不受影響：無 requiresCrimp、無 oldHouse、bonusCondition 為新增可選欄位
- `Circuit` 新增可選欄位：`contactResistance?: number`（預設 1.0）
- `Level` 新增可選欄位：`requiresCrimp?: boolean`、`bonusCondition?: BonusCondition`、`oldHouse?: OldHouseConfig`
- `step()` 函式：`contactResistance` 未設定時預設 1.0，行為完全不變
- `SimulationStatus` 不變（老屋問題透過 contactResistance 影響既有 burned 判定，不新增 status）
- 星等系統為純 UI 層，不影響任何遊戲邏輯
- localStorage 無既有資料時預設 0 星


## 7. 實作順序

| 順序 | Change 名稱 | 範圍 | 依賴 |
|------|------------|------|------|
| 1 | `crimp-terminal-system` | FR-J 全部 + L16-L17 | 無 |
| 2 | `star-rating-system` | FR-Star 全部 + L01-L20 bonusCondition | Change 1（L16-L17 的 crimp-quality condition） |
| 3 | `old-house-intro` | FR-I-Preview 全部 + L18-L20 | Change 1（壓接端子為修復必要操作） |


## 8. 後續版本方向（Roadmap Preview）

- **v0.6**：整線系統與美觀評分（FR-H — panel interior view + 線路拖曳 + 束帶 + 美觀評分）
- **v0.7**：完整老屋驚魂模式（FR-I — 更多問題類型 + 隨機老屋生成 + Before/After 對比）
- **v1.0**：弱電箱與網路系統模擬
