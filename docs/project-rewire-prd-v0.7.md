# PRD v0.7 — Project Rewire（自由配迴路 + 電器擴充）

## 0. 版本摘要

v0.7 建立在 v0.6 已完成的基礎上（23 關、10 電器、6 線材、壓接端子、三星評分、走線整理、配電箱內部視圖），聚焦解決核心遊戲平衡問題：**線材選擇過於簡單（幾乎所有關卡都能用 1.6mm² 通關）**。

兩大改動方向：
1. **自由配迴路（FR-A）** — 玩家不再面對預設好的迴路，而是自己決定要開幾條迴路、每條放什麼電器、選什麼線材和 NFB。搭配配電箱插槽上限與主開關容量限制，「迴路規劃」本身成為核心玩法。**除教學關卡（L01–L05）與老屋模式（L18–L20）外，所有關卡全面採用自由配迴路。**
2. **電器擴充 + NFB 收費（FR-B / FR-C）** — 新增高功率 110V 電器（電暖器 16.4A），讓「單一電器超過 1.6mm² 容量」成為可能。NFB 改為收費，建立「少迴路粗線 vs 多迴路細線」的成本取捨

> v0.1–v0.6 所有功能需求維持不變，本文件僅描述 **增量（delta）** 內容。
> 原 v0.7 內容（完整老屋驚魂模式）順延至 v0.8。


## 1. 產品目標（This release）

1. 讓線材選擇從「無腦 1.6mm²」變成有意義的決策
2. 引入迴路規劃作為核心玩法 — 玩家體驗真正的配電設計
3. 配電箱級別限制（插槽上限 + 主開關容量）提供真實感
4. 新增高功率電器，強制選擇更粗的線材
5. NFB 收費，建立迴路數量 vs 線材粗細的經濟取捨
6. 重新設計 L06–L17、L21–L23，全面採用自由配迴路（L18–L20 老屋維持固定迴路）

### 非目標（Not in v0.7）
- 不做老屋模式 + 自由配迴路整合（老屋概念是「修別人的爛線」，與自由規劃衝突；延至 v0.8）
- 不做不同房間不同線長（統一 DEFAULT_WIRE_LENGTH = 10m）
- 不做電器可選（所有房間電器皆為必要）


## 2. 功能需求（Functional Requirements）

### FR-A：自由配迴路機制

#### 關卡資料格式

新增 `FreeCircuitLevel` 型別，與現有固定迴路關卡共存。以 discriminated union 區分：有 `rooms` → 自由配迴路；有 `circuitConfigs` → 固定迴路。

```typescript
/** 房間定義 */
interface Room {
  id: string;
  name: string;              // '廚房', '客廳', '浴室' ...
  appliances: Appliance[];   // 此房間需要供電的電器（可能混合電壓）
  wetArea?: boolean;         // 潮濕區域（觸發 ELCB 需求）
}

/** 配電箱規格 */
interface PanelConfig {
  maxSlots: number;          // 插槽上限（可用迴路數）
  mainBreakerRating: number; // 主開關額定電流（A）
}

/** 自由配迴路關卡 */
interface FreeCircuitLevel {
  name: string;
  description: string;
  rooms: Room[];
  panel: PanelConfig;
  budget: number;
  survivalTime: number;
  bonusCondition?: BonusCondition;
  // 專項機制（可選疊加）
  phaseMode?: 'auto' | 'manual';          // 相位平衡
  leakageMode?: 'scripted' | 'random';    // 漏電模式
  leakageEvents?: LeakageEvent[];         // 腳本式漏電事件
  requiresCrimp?: boolean;                // 壓接端子
  requiresRouting?: boolean;              // 走線整理
}
```

**Level union type：**
```typescript
type Level = FixedCircuitLevel | FreeCircuitLevel;
// FixedCircuitLevel = 現有 Level 型別（含 circuitConfigs）
// 判斷方式：'rooms' in level → FreeCircuitLevel
```

#### 玩家操作流程

```
┌─────────────────────────────────────────────────┐
│ 1. 查看關卡資訊                                    │
│    房間列表 + 電器 + 配電箱規格 + 預算               │
└───────────────────┬─────────────────────────────┘
                    ▼
┌─────────────────────────────────────────────────┐
│ 2. 迴路規劃階段                                    │
│    a. 點擊「＋新增迴路」                             │
│       → 選擇電壓（110V / 220V）                    │
│       → 選擇 NFB 規格（15A / 20A / 30A）           │
│       → 若 phaseMode 存在且 110V → 選擇相位（R/T）  │
│    b. 將電器指派到迴路（點擊 / 拖曳）                 │
│       → 若迴路含 wetArea 房間電器 → ELCB toggle 出現 │
│    c. 為每條迴路選擇線材（WireSelector 拖曳）         │
│    d. 可隨時刪除迴路 / 移除電器重新分配                │
└───────────────────┬─────────────────────────────┘
                    ▼
┌─────────────────────────────────────────────────┐
│ 3. 壓接階段（若 requiresCrimp = true）              │
│    每條迴路進行壓接小遊戲（同現有 CrimpMiniGame）      │
└───────────────────┬─────────────────────────────┘
                    ▼
┌─────────────────────────────────────────────────┐
│ 4. 走線整理階段（若 requiresRouting = true）         │
│    進入 PanelInteriorView 排列走線 + 束帶            │
└───────────────────┬─────────────────────────────┘
                    ▼
┌─────────────────────────────────────────────────┐
│ 5. 送電（所有前置條件滿足後啟用）                     │
└───────────────────┬─────────────────────────────┘
                    ▼
┌─────────────────────────────────────────────────┐
│ 6. 模擬運行（同現有 + 主開關跳脫 + 漏電事件）         │
└─────────────────────────────────────────────────┘
```

#### 電器指派規則

- 每個電器只能指派到**一條**迴路
- 電器電壓必須匹配迴路電壓（110V 電器 → 110V 迴路，220V → 220V）
- 一條迴路**可以**接來自不同房間的電器（只要電壓匹配）
- 一個房間的電器**可以**分到多條迴路
- 空迴路允許存在（但浪費預算和插槽，自然被成本懲罰）

#### 迴路建立時的附加選項

| 條件 | 額外選項 | 說明 |
|------|---------|------|
| 關卡有 `phaseMode` 且迴路為 110V | **相位選擇（R / T）** | 220V 迴路跨相，無需選擇 |
| 迴路包含 wetArea 房間的電器 | **ELCB 開關** | wetArea 迴路必須啟用 ELCB 才能送電 |

#### 送電前置條件

- ✅ 所有房間的所有電器都已指派到某條迴路
- ✅ 每條迴路都已選擇線材
- ✅ 迴路數 ≤ panel.maxSlots
- ✅ 所有 wetArea 迴路已啟用 ELCB（若有 wetArea 房間）
- ✅ 所有迴路已完成壓接（若 requiresCrimp）
- ✅ 走線整理已完成（若 requiresRouting）

#### 成本模型

```
totalCost = Σ (wire.costPerMeter × DEFAULT_WIRE_LENGTH + nfbCost + elcbCost)
```

| 項目 | 計算 |
|------|------|
| 線材 | costPerMeter × 10m（同現有） |
| NFB | 15A = $10 / 20A = $15 / 30A = $20（**新增**） |
| ELCB | $35 / 迴路（同現有） |

> NFB 收費**僅適用於自由配迴路關卡**。固定迴路關卡（L01–L05, L18–L20）NFB 成本不計入，維持向後相容。

**NFB 收費的設計意義：**
- 每多開一條迴路就多一筆 NFB 費用
- 與線材成本形成取捨：少迴路 → 需粗線（貴）；多迴路 → 多 NFB 費用但可用細線
- 價格設定偏低（$10–$20），讓 NFB 成本是「輕推」而非「硬牆」


### FR-B：新增電器

| 電器 | 功率 | 電壓 | 電流 | 設計意義 |
|------|------|------|------|----------|
| 電暖器 | 1800W | 110V | **16.4A** | 單一電器超過 1.6mm²(15A)，強制 2.0mm²+ |
| 烤箱 | 1500W | 110V | 13.6A | 同快煮壺等級，增加廚房場景多樣性 |
| 除濕機 | 600W | 110V | 5.5A | 低功率填充，增加房間多樣性 |

**電暖器是關鍵新增** — 在 v0.6 之前，所有 110V 電器的電流都 ≤ 13.6A，單獨放在一條迴路時 1.6mm²（15A）永遠夠用。電暖器 16.4A 打破這個狀況，讓玩家第一次面對「單一電器就需要更粗的線」。

#### 更新後的完整電器表（13 種）

| # | 電器 | 功率 | 電壓 | 電流 | 新增/既有 |
|---|------|------|------|------|-----------|
| 1 | 吹風機 | 1200W | 110V | 10.9A | 既有 |
| 2 | 快煮壺 | 1500W | 110V | 13.6A | 既有 |
| 3 | 微波爐 | 1100W | 110V | 10.0A | 既有 |
| 4 | 廚下加熱器 | 800W | 110V | 7.3A | 既有 |
| 5 | 烘衣機 | 2200W | 220V | 10.0A | 既有 |
| 6 | 電熱水器 | 4400W | 220V | 20.0A | 既有 |
| 7 | IH 爐 | 3000W | 220V | 13.6A | 既有 |
| 8 | 冷氣 | 2800W | 220V | 12.7A | 既有 |
| 9 | 浴室暖風機 | 1650W | 220V | 7.5A | 既有 |
| 10 | 冰箱 | 200W | 110V | 1.8A | 既有 |
| 11 | **電暖器** | **1800W** | **110V** | **16.4A** | **v0.7** |
| 12 | **烤箱** | **1500W** | **110V** | **13.6A** | **v0.7** |
| 13 | **除濕機** | **600W** | **110V** | **5.5A** | **v0.7** |


### FR-C：主開關機制

配電箱主開關限制所有迴路的總電流，為配電設計增加一個全域約束。

#### 跳脫條件

```
totalPanelCurrent = Σ 所有非跳脫迴路的 totalCurrent
若 totalPanelCurrent > mainBreakerRating × 1.25 → 累積跳脫計時
超過 tripDelay(1.5s) → 主開關跳脫
```

#### 跳脫效果

- 新增 `SimulationStatus: 'main-tripped'`（severity = 3，等同 burned）
- 全面斷電 = 遊戲失敗
- 代表配電設計根本錯誤（總容量不足）

#### `stepMulti` 擴充

```typescript
function stepMulti(
  circuits: readonly Circuit[],
  state: MultiCircuitState,
  dt: number,
  phases?: Record<CircuitId, 'R' | 'T'>,
  mainBreakerRating?: number,       // 新增參數
  config?: SimulationConfig,
): MultiCircuitState
```

- 計算 `totalPanelCurrent`（所有非跳脫迴路的 totalCurrent 之和）
- 新增 `mainBreakerTripTimer` 到 MultiCircuitState
- 超過閾值則累積計時，達 tripDelay → `overallStatus = 'main-tripped'`
- 未超過則重置計時

#### UI 顯示

StatusDisplay 新增主開關負載指示（僅自由配迴路關卡顯示）：
- 顯示格式：「主開關：42A / 50A」
- 負載比 ≥ 80%：橘色警告
- 負載比 ≥ 100%：紅色危險


### FR-D：修復既有關卡 Bug

在重新設計關卡的同時，修復已知的電壓不匹配問題：

| 關卡 | Bug | 說明 |
|------|-----|------|
| L05 | 烘衣機(220V) 放在 110V 迴路 | `calcTotalCurrent` 過濾不匹配電壓 → 烘衣機不計電流 → 關卡過於簡單 |
| L07 c3 | 烘衣機(220V) 放在 110V 迴路 | 同上 |

**修復方式：** L05 改為正確的電器組合（電暖器+快煮壺）。L07 以後全面改為自由配迴路格式。


### FR-E：關卡重新設計

#### 關卡結構總覽

| 區間 | 模式 | 疊加機制 | 狀態 |
|------|------|---------|------|
| L01–L05 | 固定迴路（教學） | — | **不變**（修復 L05 bug） |
| L06–L10 | **自由配迴路** | 基礎 | **v0.7 重新設計** |
| L11–L12 | **自由配迴路** | + 相位平衡 | **v0.7 重新設計** |
| L13–L15 | **自由配迴路** | + ELCB / 漏電 | **v0.7 重新設計** |
| L16–L17 | **自由配迴路** | + 壓接端子 | **v0.7 重新設計** |
| L18–L20 | 固定迴路（老屋） | 老屋修復 | **不變**（概念衝突，v0.8 處理） |
| L21–L23 | **自由配迴路** | + 走線整理 | **v0.7 重新設計** |

#### L05 Bug 修復（固定迴路）

將烘衣機(220V) 替換為電暖器(1800W/110V) + 快煮壺(1500W/110V)，總電流 30A。描述改為：「電暖器 + 快煮壺，合計 30A。需要粗線才撐得住！」

---

#### L06–L10：基礎自由配迴路

##### L06 — 自由配迴路入門

```
描述：第一次體驗自由配迴路！兩個房間、三台電器，你來決定怎麼分。

房間：
  客廳 [吹風機(10.9A)]
  廚房 [快煮壺(13.6A), 冰箱(1.8A)]

配電箱：4 插槽 / 50A 主開關
預算：$100
存活：8 秒

設計意圖：
  首次自由配迴路體驗。所有電器 ≤ 13.6A，1.6mm² 夠用。
  重點：學會「建迴路→指派電器→選線→送電」流程。

最佳解：2 迴路，各 1.6mm²+15A = ($30+$10)×2 = $80
第三星：{ type: 'under-budget-ratio', ratio: 0.85 }
```

##### L07 — 高功率初體驗

```
描述：電暖器 16.4A — 第一次遇到 1.6mm² 不夠用的電器！

房間：
  客廳 [電暖器(16.4A), 冰箱(1.8A)]

配電箱：3 插槽 / 50A 主開關
預算：$85
存活：10 秒

設計意圖：
  電暖器 16.4A > 1.6mm²(15A)，玩家被迫使用 2.0mm²。
  預算壓力迫使合併到 1 迴路（18.2A < 20A 安全共存）。

最佳解：1 迴路，2.0mm²+20A = $50+$15 = $65
第三星：{ type: 'no-warning' }
```

##### L08 — 廚房分迴路

```
描述：快煮壺、微波爐、電暖器 — 三台高功率電器，怎麼分才划算？

房間：
  廚房 [快煮壺(13.6A), 微波爐(10.0A)]
  客廳 [電暖器(16.4A)]

配電箱：4 插槽 / 50A 主開關
預算：$150
存活：10 秒

設計意圖：
  廚房合計 23.6A，合併需 3.5mm²（貴）；拆開各用 1.6mm²（多一個 NFB）。
  電暖器強制 2.0mm²。玩家首次面對「合併 vs 拆開」的經濟取捨。

策略 A（2 迴路，廚房合併 warning）：2.0mm²+20A + 2.0mm²+20A = $130（有 warning）
策略 B（3 迴路，全拆）：1.6mm²+15A ×2 + 2.0mm²+20A = $145（無 warning）
第三星：{ type: 'no-warning' }
```

##### L09 — 混合電壓

```
描述：廚房 110V + 洗衣間 220V。不同電壓需要不同迴路！

房間：
  廚房 [快煮壺(13.6A), 烤箱(13.6A)]
  洗衣間 [烘衣機(10.0A, 220V)]

配電箱：4 插槽 / 50A 主開關
預算：$140
存活：10 秒

設計意圖：
  首次混合電壓。220V 電器必須獨立迴路。
  廚房拆開比合併便宜（27.2A 合併需 5.5mm²）。

最佳解：3 迴路各獨立，全 1.6mm²+15A = $120
第三星：{ type: 'under-budget-ratio', ratio: 0.9 }
```

##### L10 — 全屋配電

```
描述：五個房間、七台電器 — 第一次全屋配電設計！

房間：
  廚房 [快煮壺(13.6A), 微波爐(10.0A)]
  客廳 [電暖器(16.4A), 吹風機(10.9A)]
  臥室 [除濕機(5.5A)]
  洗衣間 [烘衣機(10.0A, 220V)]
  儲藏室 [冰箱(1.8A)]

配電箱：6 插槽 / 75A 主開關
預算：$250
存活：15 秒

設計意圖：
  最複雜的基礎自由配迴路關卡。多房間、混合電壓、插槽限制。
  需要在插槽和預算之間找最佳分配。精確數值 playtest 微調。

第三星：{ type: 'under-budget-ratio', ratio: 0.85 }
```

---

#### L11–L12：自由配迴路 + 相位平衡

##### L11 — 相位平衡入門

```
描述：單相三線制登場！R 相和 T 相要均衡分配，否則中性線過載燒毀。

房間：
  廚房 [快煮壺(13.6A), 冰箱(1.8A)]
  客廳 [吹風機(10.9A), 除濕機(5.5A)]
  冷氣間 [冷氣(12.7A, 220V)]

配電箱：5 插槽 / 75A 主開關
預算：$200
存活：12 秒
phaseMode：auto（系統自動分配相位，玩家需觀察平衡）

設計意圖：
  首次相位平衡 + 自由配迴路。玩家必須把電器合理分配到 R 相和 T 相迴路。
  若所有 110V 迴路都放 R 相 → 中性線電流 = 全部 R 電流 → 過載風險。
  220V 冷氣跨相，不影響中性線。

第三星：{ type: 'time-margin', margin: 3 }
```

##### L12 — 相位平衡進階

```
描述：更多電器、手動相位切換。你來決定哪條迴路走 R 相、哪條走 T 相。

房間：
  廚房 [快煮壺(13.6A), 微波爐(10.0A), 烤箱(13.6A)]
  客廳 [電暖器(16.4A), 吹風機(10.9A)]
  儲藏室 [冰箱(1.8A)]
  冷氣間 [冷氣(12.7A, 220V)]

配電箱：6 插槽 / 75A 主開關
預算：$280
存活：15 秒
phaseMode：manual

設計意圖：
  高功率 110V 電器多，相位分配是核心挑戰。
  若廚房全放 R 相 → R 相電流遠超 T 相 → 中性線過載。
  玩家需要在迴路規劃階段就思考相位平衡。

第三星：{ type: 'time-margin', margin: 3 }
```

---

#### L13–L15：自由配迴路 + ELCB / 漏電

##### L13 — ELCB 入門

```
描述：浴室潮濕區必須安裝 ELCB。不裝 = 觸電！

房間：
  浴室 [浴室暖風機(7.5A, 220V)] (wetArea)
  臥室 [吹風機(10.9A)]

配電箱：4 插槽 / 50A 主開關
預算：$150
存活：10 秒
leakageMode：scripted
leakageEvents：[{ time: 5, circuitId: 動態（浴室迴路） }]

設計意圖：
  首次 ELCB + 自由配迴路。玩家建浴室迴路時看到 ELCB toggle。
  不裝 ELCB → 第 5 秒漏電 → 觸電失敗。裝了 → ELCB 跳脫保護。
  ELCB 成本 $35 壓縮線材預算。

第三星：{ type: 'no-trip' }
```

> **注意：** scripted leakageEvent 的 circuitId 需要在迴路規劃完成後動態綁定到包含 wetArea 電器的迴路。實作時 GameBoard 在規劃→模擬轉換時處理此映射。

##### L14 — ELCB 預算壓力

```
描述：浴室 ELCB 必裝，加上廚房高功率電器，預算很緊。

房間：
  浴室 [浴室暖風機(7.5A, 220V)] (wetArea)
  廚房 [快煮壺(13.6A), 微波爐(10.0A)]
  儲藏室 [冰箱(1.8A)]

配電箱：5 插槽 / 50A 主開關
預算：$185
存活：12 秒
leakageMode：random

設計意圖：
  ELCB $35 吃掉預算，廚房迴路設計更受限。
  廚房合併 vs 拆開的取捨，加上 ELCB 成本壓力。

第三星：{ type: 'no-trip' }
```

##### L15 — 綜合挑戰

```
描述：相位平衡 + ELCB + 多房間。所有 v0.4 機制的自由配迴路版！

房間：
  廚房 [快煮壺(13.6A), 微波爐(10.0A)]
  客廳 [電暖器(16.4A)]
  浴室 [浴室暖風機(7.5A, 220V)] (wetArea)
  冷氣間 [冷氣(12.7A, 220V)]

配電箱：6 插槽 / 75A 主開關
預算：$300
存活：20 秒
phaseMode：manual
leakageMode：random

設計意圖：
  v0.4 機制畢業考的自由配迴路版。相位+ELCB+預算+迴路規劃。

第三星：{ type: 'no-trip' }
```

---

#### L16–L17：自由配迴路 + 壓接端子

##### L16 — 壓接端子入門

```
描述：接好線後要壓接才能送電。低壓力環境學習壓接。

房間：
  客廳 [吹風機(10.9A), 冰箱(1.8A)]

配電箱：3 插槽 / 50A 主開關
預算：$80
存活：8 秒
requiresCrimp：true

設計意圖：
  簡單的迴路規劃 + 壓接流程。重點是學習完整的「規劃→壓接→送電」流程。

第三星：{ type: 'crimp-quality', minQuality: 'good' }
```

##### L17 — 端子品質大考驗

```
描述：壓接品質差 = 接觸電阻高 = 線材加速過熱！廚房高功率迴路要壓好。

房間：
  廚房 [快煮壺(13.6A), 微波爐(10.0A)]
  冷氣間 [IH 爐(13.6A, 220V)]

配電箱：4 插槽 / 50A 主開關
預算：$180
存活：12 秒
requiresCrimp：true

設計意圖：
  廚房合計 23.6A，壓接品質差 → effectiveCurrent 更高 → 更容易過載。
  迴路規劃 + 壓接品質雙重挑戰。

第三星：{ type: 'crimp-quality', minQuality: 'good' }
```

---

#### L18–L20：固定迴路（老屋，不變）

維持現有設計。老屋模式的概念是「修別人接的爛線」，預設迴路和問題是核心體驗，與自由配迴路衝突。v0.8 會擴充老屋模式。

---

#### L21–L23：自由配迴路 + 走線整理

##### L21 — 整線入門

```
描述：設計迴路後進入配電箱整理走線。學習車道排列和束帶。

房間：
  客廳 [吹風機(10.9A)]
  儲藏室 [冰箱(1.8A)]
  廚房 [廚下加熱器(7.3A)]

配電箱：4 插槽 / 50A 主開關
預算：$150
存活：10 秒
phaseMode：auto
requiresCrimp：true
requiresRouting：true

設計意圖：
  自由配迴路 + 走線整理。玩家先規劃 3 迴路，再進入配電箱排列走線。
  低功率電器，迴路規劃壓力小，讓玩家專注學習走線。

第三星：{ type: 'aesthetics-score', minScore: 90 }
```

##### L22 — 交叉迷宮

```
描述：5 個房間 + 混合電壓 + 手動相位。迴路規劃直接影響走線難度！

房間：
  廚房 [快煮壺(13.6A), 微波爐(10.0A)]
  客廳 [電暖器(16.4A)]
  陽台 [烘衣機(10.0A, 220V)]
  儲藏室 [冰箱(1.8A)]
  臥室 [除濕機(5.5A)]

配電箱：6 插槽 / 75A 主開關
預算：$300
存活：12 秒
phaseMode：manual
requiresCrimp：true
requiresRouting：true

設計意圖：
  迴路規劃影響走線：相同相位的迴路相鄰排列可減少交叉。
  玩家需要同時考慮「電氣安全」和「整線美觀」。

第三星：{ type: 'aesthetics-score', minScore: 80 }
```

##### L23 — 完美配電箱

```
描述：v0.7 畢業考！全機制綜合 — 自由配迴路 + 相位 + ELCB + 壓接 + 走線。

房間：
  廚房 [快煮壺(13.6A), 微波爐(10.0A)]
  客廳 [電暖器(16.4A), 吹風機(10.9A)]
  浴室 [浴室暖風機(7.5A, 220V)] (wetArea)
  冷氣間 [冷氣(12.7A, 220V)]
  儲藏室 [冰箱(1.8A)]

配電箱：8 插槽 / 75A 主開關
預算：$400
存活：15 秒
phaseMode：manual
leakageMode：random
requiresCrimp：true
requiresRouting：true

設計意圖：
  全機制總決算。6 個房間、混合電壓、相位平衡、ELCB、壓接、走線。
  迴路規劃 → 壓接 → 走線 → 送電，完整配電體驗。

第三星：{ type: 'aesthetics-score', minScore: 70 }
```

> **所有關卡的精確預算/插槽/主開關數值在實作時 playtest 微調。**


## 3. 更新後的完整數據表

### 線材（6 種，不變）

| 線徑 | 安全電流 | 每米成本 | 10m 總成本 | 顏色 |
|------|----------|---------|-----------|------|
| 1.6mm² | 15A | $3 | $30 | 藍 |
| 2.0mm² | 20A | $5 | $50 | 綠 |
| 3.5mm² | 25A | $8 | $80 | 黃 |
| 5.5mm² | 30A | $12 | $120 | 橘 |
| 8.0mm² | 45A | $18 | $180 | 紅 |
| 14mm² | 70A | $28 | $280 | 紫 |

### NFB（3 種，新增收費）

| 規格 | 額定電流 | 跳脫閾值（×1.25） | 單價（自由配迴路） | 固定迴路 |
|------|----------|-------------------|--------------------|----------|
| 15A | 15A | 18.75A | **$10** | 免費 |
| 20A | 20A | 25.0A | **$15** | 免費 |
| 30A | 30A | 37.5A | **$20** | 免費 |

### 電器（13 種，新增 3 種）

（見 FR-B 完整電器表）


## 4. UI 設計要點

### 自由配迴路規劃畫面

此為 v0.7 最重要的新 UI。需展示：

1. **房間清單**（左側/上方）
   - 每個房間名稱 + 底下列出電器（名稱 + 功率 + 電壓 + 電流）
   - 已指派的電器灰化或帶 ✓，未指派的高亮
   - wetArea 房間標示 💧

2. **迴路規劃區**（中間）
   - 每條迴路一張卡片：電壓、NFB、相位（若有）、ELCB（若需要）、已指派電器、總電流、線材
   - 「＋新增迴路」按鈕（剩餘插槽數提示）
   - 每條迴路卡片上有：刪除按鈕、NFB 選擇器、相位選擇器（若 phaseMode）、ELCB toggle（若 wetArea）、線材拖曳目標區
   - 電流 vs 線材安全容量的即時顯示（綠/黃/紅）

3. **配電箱資訊**（右側/下方）
   - 插槽使用量：「3 / 6 插槽」
   - 主開關負載預估：「預估 42A / 50A」
   - 相位平衡預估（若 phaseMode）：「R: 24A / T: 12A / N: 12A」
   - 總成本：「$135 / $200 預算」
   - 送電按鈕（或「開始壓接」/「開始整線」按鈕，依關卡流程）

4. **成本明細 tooltip**
   - hover 總成本 → 展開：各迴路線材 + NFB + ELCB 成本

> **UI 細節設計在實作階段使用 `/frontend-design` skill 產出。**


## 5. 模擬引擎變更

### stepMulti 擴充

新增 `mainBreakerRating` 參數和 `mainBreakerTripTimer` 狀態：

```typescript
interface MultiCircuitState {
  // 既有欄位...
  mainBreakerTripTimer: number;  // 新增
}
```

邏輯：
1. 計算 `totalPanelCurrent = Σ 非跳脫迴路的 totalCurrent`
2. 若 `totalPanelCurrent > mainBreakerRating × 1.25` → `mainBreakerTripTimer += dt`
3. 若 `mainBreakerTripTimer >= 1.5` → `overallStatus = 'main-tripped'`
4. 否則重置 `mainBreakerTripTimer = 0`

### worstStatus 擴充

新增 `'main-tripped'` 到 `SimulationStatus`，severity = 3（同 burned）。

### 漏電事件的動態 circuitId

自由配迴路中，circuitId 在規劃完成後才確定。scripted leakageEvent 需使用「房間 ID」或「wetArea 迴路」作為間接參照，GameBoard 在規劃→模擬轉換時映射為實際 circuitId。


## 6. 關鍵設計決策摘要

| 決策 | 選擇 | 理由 |
|------|------|------|
| 自由配迴路 vs 固定迴路 | 共存（Level union type） | 教學(L01–L05)和老屋(L18–L20)保持固定，其他全面開放 |
| NFB 收費僅自由配迴路 | 固定迴路免費 | 向後相容，不改教學/老屋關卡平衡 |
| NFB 定價 $10/$15/$20 | 偏低定價 | 輕推而非硬牆，不讓 NFB 成本壓過線材成本 |
| 電器指派以電器為單位 | 非以房間為單位 | 允許同房間拆多迴路（使用者需求） |
| 主開關跳脫 = 遊戲失敗 | severity 3（同 burned） | 總容量設計錯誤是根本性問題 |
| 主開關跳脫有 tripDelay | 1.5 秒延遲 | 與 NFB 一致，不會太突然 |
| 空迴路允許 | 浪費預算自然懲罰 | 不需硬性禁止，減少規則記憶負擔 |
| 新增電暖器(16.4A) | 超過 1.6mm² 容量 | 解決「單一電器永遠不需粗線」的根本問題 |
| 相位整合到迴路建立 | 110V 迴路選 R/T | 自然融入規劃流程，不需額外步驟 |
| ELCB 整合到迴路建立 | wetArea 電器 → toggle 出現 | 沿用現有機制，僅觸發條件改變 |
| 壓接/走線流程不變 | 規劃完成後依序進行 | 這些機制在迴路建立之後，不受影響 |
| L18–L20 維持固定迴路 | 老屋 = 修別人的線 | 概念衝突，v0.8 專門處理 |
| 漏電 circuitId 動態映射 | 用 wetArea 迴路間接參照 | 自由配迴路中 circuitId 不固定 |


## 7. 向後相容性

- L01–L05：完全不變
- L06–L17, L21–L23：替換為自由配迴路版本（localStorage 星等自動重置）
- L18–L20：完全不變（固定迴路老屋模式）
- `Level` type：改為 `FixedCircuitLevel | FreeCircuitLevel` union，既有欄位向後相容
- `FreeCircuitLevel`：新增 `rooms` / `panel` 欄位 + 沿用 `phaseMode` / `leakageMode` / `requiresCrimp` / `requiresRouting` 等既有欄位
- `SimulationStatus`：新增 `'main-tripped'`，`worstStatus` 擴充支援
- `MultiCircuitState`：新增 `mainBreakerTripTimer` 欄位（預設 0）
- `DEFAULT_APPLIANCES`：新增 3 種電器（附加到陣列末尾）
- 新增常數：`NFB_COST_15A = 10`, `NFB_COST_20A = 15`, `NFB_COST_30A = 20`
- 新增元件：
  - `src/components/CircuitPlanner.tsx` — 迴路規劃主 UI
  - `src/components/RoomPanel.tsx` — 房間/電器清單
  - `src/components/CircuitCard.tsx` — 單條迴路卡片（含相位/ELCB/NFB 選擇器）
- GameBoard 擴充：偵測關卡類型 → 自由配迴路 → 規劃階段 → 轉換為 Circuit[] → 壓接/走線 → 模擬


## 8. 實作順序

| 順序 | Change 名稱 | 範圍 | 依賴 |
|------|------------|------|------|
| 1 | `new-appliances-and-nfb-cost` | 新增 3 種電器 + NFB 成本常數 + 成本計算擴充 + 修復 L05 bug | 無 |
| 2 | `free-circuit-data-model` | FreeCircuitLevel / Room / PanelConfig 型別 + Level union type | Change 1 |
| 3 | `circuit-planner-ui` | CircuitPlanner + RoomPanel + CircuitCard 元件 + GameBoard 規劃階段整合 + 基礎迴路建立（電壓/NFB/電器指派/選線）| Change 2 |
| 4 | `main-breaker-simulation` | stepMulti 主開關跳脫 + MultiCircuitState 擴充 + StatusDisplay 主開關負載 + worstStatus 擴充 | Change 2 |
| 5 | `planner-phase-elcb` | 迴路規劃加入相位選擇器 + ELCB toggle + 相位平衡預估顯示 + 漏電 circuitId 動態映射 | Change 3 |
| 6 | `free-circuit-levels` | L06–L17, L21–L23 全部關卡定義（FreeCircuitLevel 格式）| Change 5 |
| 7 | `level-balance-tuning` | 全關卡精確數值調校（playtest 後微調預算/插槽/主開關）| Change 6 |


## 9. 後續版本方向（Roadmap Preview）

- **v0.8**：完整老屋驚魂模式（原 v0.7 內容 — 新問題類型、NFB 更換、Before/After、隨機老屋）
- **v0.9+**：老屋 + 自由配迴路整合、進階配電設計
- **v1.0**：全機制統一體驗
