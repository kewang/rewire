# PRD v0.4 — Project Rewire（配電盤燒線 Demo / 相位平衡與安全保護版）

## 0. 版本摘要

v0.4 建立在 v0.3 已完成的基礎上（9 關、6 電器、5 線材、多迴路、電壓區分），聚焦三個方向：
1. **材料擴充** — 新增高功率電器與大口徑線材，支撐進階場景
2. **單相三線制相位平衡** — 引入紅相/黑相概念，中性線電流成為新的策略維度
3. **ELCB 漏電保護** — 漏電斷路器作為安全投資，帶來預算取捨的新決策

> v0.1–v0.3 所有功能需求維持不變，本文件僅描述 **增量（delta）** 內容。


## 1. 產品目標（This release）

在 v0.3 的基礎上：
1. 引入單相三線制相位平衡作為進階策略層，讓玩家理解「不只是電流大小，分配也很重要」
2. 新增 ELCB 漏電斷路器，帶來「安全投資 vs 預算取捨」的決策
3. 擴充電器與線材庫，支撐家庭常見大電流場景（IH 爐、冷氣、冰箱、浴室暖風機）
4. 維持漸進式難度設計：新機制各有入門關與進階關

### 非目標（Not in v0.4）
- 不做整線系統與美觀評分
- 不做老屋驚魂模式
- 不做壓接端子
- 不做弱電 / 網路


## 2. 功能需求（Functional Requirements）

### FR-G：材料擴充（Extended Materials II）

v0.3 有 5 線材 / 6 電器。v0.4 擴充至 6 線材 / 10 電器，並引入 NFB 多樣化與 ELCB 成本項目。

**實作順序：最先實作，為 FR-E、FR-F 提供內容基礎。**

#### 新增線材

| 線徑 | 類型 | 安全電流 | 成本/米 | 說明 |
|------|------|----------|---------|------|
| 14mm² | 絞線 | 70A | $28 | 超大電流用，進階關卡預算陷阱 |

#### 新增電器

| 電器 | 功率 | 電壓 | 電流 | 說明 |
|------|------|------|------|------|
| IH 爐 | 3000W | 220V | 13.6A | 高功率廚房電器，需 220V 專用迴路 |
| 冰箱 | 200W | 110V | 1.8A | 低功率持續性負載，分配策略用 |
| 冷氣 | 2800W | 220V | 12.7A | 家庭大電流，需專用迴路 |
| 浴室暖風機 | 1650W | 220V | 7.5A | 浴室場景，搭配 ELCB 漏電保護 |

#### NFB 額定多樣化

v0.1–v0.3 NFB 固定 20A。v0.4 起 NFB 額定由關卡定義，支援三種規格：

| 額定電流 | 跳脫閾值 (1.25×) | 跳脫延遲 | 說明 |
|----------|-------------------|----------|------|
| 15A | 18.75A | 1.5s | 照明/低功率迴路 |
| 20A | 25A | 1.5s | 一般插座迴路（現有預設） |
| 30A | 37.5A | 1.5s | 大電流專用迴路 |

**設計決策：**
- NFB 無成本（維持現有模式），由關卡 `circuitConfigs` 中的 `breaker` 定義
- 避免所有舊關卡（L01-L09）的預算計算失效
- 玩家不選 NFB，但需理解不同迴路的 NFB 額定差異

#### ELCB 成本項目

- ELCB（漏電斷路器）為 v0.4 唯一新增的玩家可選成本項目
- 每迴路 $35（介於 1.6mm² 線材 $30 和 2.0mm² 線材 $50 之間）
- 成本公式更新：`totalCost = Σ(wire.costPerMeter × wireLength) + Σ(hasELCB ? 35 : 0)`

**驗收條件：**
- 線材庫顯示 6 種線材，電器庫顯示 10 種電器
- 新電器正確以對應電壓計算電流
- 關卡可指定不同 NFB 額定（15A/20A/30A）
- ELCB 選項出現在適用的關卡中，正確計算成本


### FR-E：單相三線制相位平衡（Phase Balancing）

引入台灣住宅單相三線制配電概念。

#### 背景知識

台灣住宅進屋線為單相三線制：
- **紅相（R-N）**：110V — 紅色火線對中性線
- **黑相（T-N）**：110V — 黑色火線對中性線
- **跨相（R-T）**：220V — 紅色火線對黑色火線

#### 中性線電流模型

- **中性線電流**：`I_N = |Σ I_R − Σ I_T|`（簡化模型，忽略相角差異）
  - `Σ I_R` = 所有紅相(R-N) 110V 迴路的電流總和
  - `Σ I_T` = 所有黑相(T-N) 110V 迴路的電流總和
- **220V 迴路（R-T）不貢獻中性線電流**（跨相電流不經過中性線）
- **中性線容量**：30A（固定，不引入中性線線材選擇）
- **中性線熱度模型**：與一般線材相同（heatRate=0.4, coolRate=0.15），超過 30A 開始加熱
- **中性線燒毀**：wireHeat 達 1.0 時觸發新失敗類型 `"neutral-burned"`

#### 相位分配模式

| 模式 | 適用場景 | 玩家操作 |
|------|----------|----------|
| 自動分配 | 入門關 | 關卡定義每個 110V 迴路的相位（R 或 T），玩家透過電器分配間接影響平衡 |
| 手動分配 | 進階關 | 玩家可切換 110V 迴路的相位（R↔T toggle），220V 迴路固定為跨相 |

#### UI 呈現

- 相位平衡指示器：顯示紅相總電流、黑相總電流、中性線電流
- 中性線狀態視覺化（正常/預警/燒毀），與迴路線材熱度同理
- 手動模式下，110V 迴路旁顯示 R/T 切換按鈕

**驗收條件：**
- 中性線電流即時計算並顯示
- 不平衡導致中性線過載時，正確觸發預警→燒毀流程
- 220V 迴路不影響中性線電流
- 手動模式下可切換 110V 迴路的相位
- 新失敗類型 `"neutral-burned"` 正確顯示失敗原因


### FR-F：ELCB 漏電斷路器（Earth Leakage Circuit Breaker）

引入漏電保護機制，教育玩家理解浴室等潮濕環境的安全規範。

#### 核心機制

- **ELCB 功能**：偵測漏電流超過 30mA 閾值時，瞬間跳脫該迴路
- **浴室迴路必裝規則**：標記為 `wetArea: true` 的迴路必須安裝 ELCB，否則無法送電
- **其他迴路可選**：玩家可自由決定是否加裝（預算取捨）

#### 漏電事件觸發

| 模式 | 適用場景 | 觸發方式 |
|------|----------|----------|
| 腳本式 | 入門關 | 關卡定義固定觸發時間點（如通電第 5 秒） |
| 隨機式 | 進階關 | `wetArea` 迴路每秒 5% 機率觸發漏電（20 秒內觸發機率 ≈ 64%） |

#### 漏電後果

| 狀態 | 有 ELCB | 無 ELCB |
|------|---------|---------|
| 漏電發生 | ELCB 跳脫，該迴路斷電，其他迴路繼續運作 | 立即觸發 `"leakage"` 失敗（觸電危險） |

- ELCB 跳脫後，該迴路電器停止運作
- 如果該迴路有必要電器（requiredAppliances），未達存活時間仍算失敗（但失敗原因為迴路中斷，非觸電）

#### 成本

- ELCB：$35/迴路
- 不安裝 ELCB 的非 `wetArea` 迴路不受漏電事件影響（乾燥環境不會漏電）

**驗收條件：**
- `wetArea` 迴路未安裝 ELCB 時無法送電（送電按鈕 disabled + 提示）
- 漏電事件觸發時，有 ELCB 的迴路正確跳脫
- 無 ELCB 的 `wetArea` 迴路漏電時觸發即時失敗
- ELCB 成本正確計入總成本
- 乾燥迴路不觸發漏電事件


## 3. 更新後的完整數據表

### 線材（6 種）

| 線徑 | 類型 | 安全電流 | 成本/米 |
|------|------|----------|---------|
| 1.6mm² | 單芯線 | 15A | $3 |
| 2.0mm² | 單芯線 | 20A | $5 |
| 3.5mm² | 絞線 | 25A | $8 |
| 5.5mm² | 絞線 | 30A | $12 |
| 8mm² | 絞線 | 45A | $18 |
| 14mm² | 絞線 | 70A | $28 |

### 電器（10 種）

| 電器 | 功率 | 電壓 | 電流 |
|------|------|------|------|
| 吹風機 | 1200W | 110V | 10.9A |
| 快煮壺 | 1500W | 110V | 13.6A |
| 微波爐 | 1100W | 110V | 10.0A |
| 廚下加熱器 | 800W | 110V | 7.3A |
| 冰箱 | 200W | 110V | 1.8A |
| 烘衣機 | 2200W | 220V | 10.0A |
| 電熱水器 | 4400W | 220V | 20.0A |
| IH 爐 | 3000W | 220V | 13.6A |
| 冷氣 | 2800W | 220V | 12.7A |
| 浴室暖風機 | 1650W | 220V | 7.5A |

### NFB（3 種額定）

| 額定電流 | 跳脫閾值 (1.25×) | 跳脫延遲 |
|----------|-------------------|----------|
| 15A | 18.75A | 1.5s |
| 20A | 25.0A | 1.5s |
| 30A | 37.5A | 1.5s |

### ELCB 漏電斷路器

| 參數 | 值 |
|------|-----|
| 漏電閾值 | 30mA |
| 跳脫速度 | 瞬間（0s） |
| 成本 | $35/迴路 |

### 中性線

| 參數 | 值 |
|------|-----|
| 安全容量 | 30A |
| 熱度上升率 | 0.4/s（同線材） |
| 冷卻率 | 0.15/s（同線材） |


## 4. 新關卡設計（L10-L15）

### L10 新電器暖身
- **電器**：IH 爐 (3000W/220V) + 冰箱 (200W/110V) + 微波爐 (1100W/110V)
- **預算**：$150
- **存活時間**：10 秒
- **迴路配置**：
  - c1「廚房」110V / 20A NFB — 可用：冰箱、微波爐
  - c2「IH 爐」220V / 20A NFB — 可用：IH 爐
- **設計意圖**：認識新電器。IH 爐 13.6A 需 220V 專用迴路，2.0mm²（20A）剛好。廚房迴路 1.8+10.0=11.8A，1.6mm²（15A）即可。預算寬裕，容錯空間大
- **正確策略**：c1 用 1.6mm²（$30），c2 用 2.0mm²（$50），總成本 $80 ≤ $150 ✓
- **錯誤策略**：c2 用 1.6mm²（15A < 13.6A，勉強但 NFB 25A 不跳 → 加熱 → 燒毀）

### L11 相位平衡入門
- **電器**：快煮壺 (1500W/110V) + 吹風機 (1200W/110V) + 冰箱 (200W/110V) + 冷氣 (2800W/220V)
- **預算**：$200
- **存活時間**：12 秒
- **相位模式**：自動分配
- **迴路配置**：
  - c1「廚房」110V / 20A NFB / **紅相(R)** — 可用：快煮壺、冰箱
  - c2「客廳」110V / 20A NFB / **黑相(T)** — 可用：吹風機、冰箱
  - c3「冷氣」220V / 30A NFB — 可用：冷氣
- **中性線分析**：
  - 最佳分配：c1 快煮壺(13.6A) + c2 吹風機(10.9A) → I_N = |13.6 − 10.9| = 2.7A ✓
  - 最差分配：c1 快煮壺+冰箱(15.4A) + c2 空 → I_N = 15.4A（仍安全，但展示概念）
- **設計意圖**：第一次看到相位平衡指示器與中性線電流。自動分配相位，玩家透過電器分配間接體驗平衡概念。冷氣 220V 跨相不影響中性線
- **正確策略**：合理分配電器到兩個 110V 迴路，中性線電流低。各迴路選適當線材
- **錯誤策略**：全部 110V 電器塞到同一迴路 → 迴路過載 + 中性線電流偏高（但此關不會燒中性線，僅作概念展示）

### L12 相位平衡進階
- **電器**：快煮壺 (1500W/110V) + 微波爐 (1100W/110V) + 吹風機 (1200W/110V) + 廚下加熱器 (800W/110V) + 冰箱 (200W/110V) + 冷氣 (2800W/220V)
- **預算**：$250
- **存活時間**：15 秒
- **相位模式**：手動分配
- **迴路配置**：
  - c1「廚房A」110V / 20A NFB / 預設紅相(R) — 可用：快煮壺、微波爐、廚下加熱器
  - c2「廚房B」110V / 20A NFB / 預設紅相(R) — 可用：微波爐、廚下加熱器、吹風機
  - c3「客廳」110V / 15A NFB / 預設黑相(T) — 可用：吹風機、冰箱
  - c4「冷氣」220V / 30A NFB — 可用：冷氣
- **中性線分析**：
  - 全部 110V 放同相：紅相 13.6+10.0+10.9+7.3+1.8=43.6A（假設全紅），黑相 0A → I_N = 43.6A > 30A → 燒中性線！
  - 平衡策略：c1 紅相（快煮壺 13.6A + 廚下 7.3A = 20.9A），c2 黑相（微波 10.0A + 吹風機 10.9A = 20.9A），c3 黑相（冰箱 1.8A）→ I_N = |20.9 − (20.9+1.8)| = 1.8A ✓
  - 注意：c3 用 15A NFB，冰箱 1.8A 輕鬆；但若放吹風機 10.9A 也可以（不超 15A），策略靈活
- **成本計算**（正確策略）：c1 3.5mm²($80) + c2 3.5mm²($80) + c3 1.6mm²($30) + c4 2.0mm²($50) = $240 ≤ $250 ✓
- **設計意圖**：首次讓玩家手動切換相位。預設全在紅相，不調整必燒中性線。需要理解「平衡分配」才能過關
- **正確策略**：將 c1/c2 分到不同相位，平衡中性線電流。c3 放冰箱（低負載 + 低成本線材）
- **錯誤策略**：不切換相位 → 中性線過載 → neutral-burned 失敗

### L13 ELCB 入門
- **電器**：浴室暖風機 (1650W/220V) + 電熱水器 (4400W/220V) + 吹風機 (1200W/110V)
- **預算**：$200
- **存活時間**：10 秒
- **漏電模式**：腳本式（浴室迴路在第 5 秒觸發漏電）
- **迴路配置**：
  - c1「浴室」220V / 30A NFB / **wetArea** — 可用：浴室暖風機、電熱水器
  - c2「臥室」110V / 20A NFB — 可用：吹風機
- **設計意圖**：認識 ELCB 機制。浴室迴路強制安裝 ELCB（不裝無法送電）。第 5 秒漏電觸發 → ELCB 跳脫 → 浴室斷電。但浴室電器不在 requiredAppliances 中，只要臥室撐滿 10 秒即可過關
- **成本計算**：c1 ELCB $35 + 線材。浴室 7.5+20.0=27.5A 需 5.5mm²($120) 或以上。c2 吹風機 10.9A 需 1.6mm²($30)。最低成本 = $35 + $120 + $30 = $185 ≤ $200 ✓
- **requiredAppliances**：[吹風機]（浴室電器不要求持續運作）
- **正確策略**：浴室裝 ELCB + 適當線材，臥室輕鬆過關。ELCB 跳脫後浴室斷電不影響結果
- **錯誤策略**：浴室不裝 ELCB → 無法送電

### L14 ELCB 預算壓力
- **電器**：浴室暖風機 (1650W/220V) + 快煮壺 (1500W/110V) + 微波爐 (1100W/110V) + 冰箱 (200W/110V)
- **預算**：$185
- **存活時間**：12 秒
- **漏電模式**：隨機式（wetArea 迴路 5%/秒）
- **迴路配置**：
  - c1「浴室」220V / 20A NFB / **wetArea** — 可用：浴室暖風機
  - c2「廚房」110V / 20A NFB — 可用：快煮壺、微波爐、冰箱
  - c3「儲藏室」110V / 15A NFB — 可用：冰箱
- **設計意圖**：浴室 ELCB 必裝（$35），壓縮線材預算。廚房高負載但預算不夠用最粗線。同時考慮 ELCB 跳脫的風險 — 浴室暖風機不在必要電器中，ELCB 跳了也沒關係
- **成本計算**：
  - c1 ELCB $35 + 暖風機 7.5A → 1.6mm² $30 即可。小計 $65
  - c2 快煮壺+微波 = 13.6+10.0 = 23.6A → 3.5mm²(25A) $80 或 5.5mm²(30A) $120
  - c3 冰箱 1.8A → 1.6mm² $30
  - 方案 A（c2 用 3.5mm²）：$65+$80+$30 = $175 ≤ $185 ✓（但 23.6A 接近 25A 上限）
  - 方案 B（c2 用 5.5mm²）：$65+$120+$30 = $215 > $185 ✗（超預算）
- **requiredAppliances**：[快煮壺, 微波爐, 冰箱]（浴室暖風機不要求）
- **正確策略**：浴室裝 ELCB + 最低線材，廚房用 3.5mm² 剛好撐住，冰箱走儲藏室低負載迴路
- **錯誤策略**：廚房選 2.0mm²（20A < 23.6A → 燒線）；或不分散冰箱 → 廚房更擠

### L15 綜合挑戰
- **電器**：IH 爐 (3000W/220V) + 快煮壺 (1500W/110V) + 微波爐 (1100W/110V) + 吹風機 (1200W/110V) + 浴室暖風機 (1650W/220V) + 冰箱 (200W/110V)
- **預算**：$300
- **存活時間**：20 秒
- **相位模式**：手動分配
- **漏電模式**：隨機式（wetArea 迴路 5%/秒）
- **迴路配置**：
  - c1「廚房A」110V / 20A NFB / 預設紅相(R) — 可用：快煮壺、微波爐、冰箱
  - c2「廚房B」110V / 20A NFB / 預設紅相(R) — 可用：微波爐、吹風機、冰箱
  - c3「浴室」220V / 20A NFB / **wetArea** — 可用：浴室暖風機
  - c4「IH 爐」220V / 30A NFB — 可用：IH 爐
- **相位分析**：
  - 正確：c1 紅相（快煮壺 13.6A），c2 黑相（微波 10.0A + 吹風機 10.9A = 20.9A）→ I_N = |13.6 − 20.9| = 7.3A ✓
  - 也可：c1 紅相（快煮壺 13.6A + 冰箱 1.8A = 15.4A），c2 黑相（微波 10.0A + 吹風機 10.9A = 20.9A）→ I_N = |15.4 − 20.9| = 5.5A ✓
  - 錯誤：不切相 → 全紅相 13.6+10.0+10.9+1.8 = 36.3A → I_N = 36.3A > 30A → 燒中性線
- **成本計算**（以正確策略為例）：
  - c1 快煮壺 13.6A → 2.0mm² $50（或含冰箱 15.4A → 仍 2.0mm²）
  - c2 微波+吹風 20.9A → 3.5mm² $80
  - c3 ELCB $35 + 暖風機 7.5A → 1.6mm² $30 = $65
  - c4 IH 爐 13.6A → 2.0mm² $50
  - 總成本 = $50+$80+$65+$50 = $245 ≤ $300 ✓
- **requiredAppliances**：[快煮壺, 微波爐, 吹風機, IH 爐, 冰箱]（浴室暖風機不要求）
- **設計意圖**：v0.4 畢業考。同時需要：(1) 相位平衡避免燒中性線 (2) 浴室 ELCB 強制安裝 (3) 合理分配電器到迴路 (4) 控制預算選線材。20 秒存活時間 + 隨機漏電增加緊張感
- **正確策略**：手動切相平衡 + 浴室 ELCB + 各迴路選合適線材 + 冰箱放最低負載迴路
- **錯誤策略**：不切相（燒中性線）/ 線材太細（燒線）/ 分配不均（迴路過載）


## 5. 關鍵設計決策摘要

| 決策 | 選擇 | 理由 |
|------|------|------|
| NFB 成本 | 無（關卡定義） | 避免破壞 L01-L09 現有預算 |
| ELCB 成本 | $35/迴路 | 介於最便宜線($30)和中等線($50)之間，有感但不壓倒 |
| 中性線容量 | 30A 固定 | 簡化模型，不引入中性線線材選擇 |
| 中性線電流公式 | \|Σ I_R − Σ I_T\| | 簡化忽略相角，教育意義足夠 |
| 漏電機率 | 5%/秒 | 20 秒內觸發機率 ≈ 64%，有足夠緊張感 |
| 無 ELCB 漏電 | 即時失敗 | 觸電 = 不可恢復，教育意義明確 |
| 新關卡數 | 6 關（L10-L15） | 每個新機制 2 關（入門+進階）+ 綜合挑戰 |
| 相位分配 | 混合模式 | 入門自動/進階手動，降低學習門檻 |
| 實作順序 | FR-G → FR-E → FR-F | 材料先行，相位模型次之，ELCB 最後 |


## 6. 向後相容性

- L01-L09 不受影響：NFB 無成本、無相位、無 ELCB、無 wetArea
- `CircuitConfig` 新增可選欄位：`phase?: 'R' | 'T'`（僅 110V）、`wetArea?: boolean`、`phaseMode?: 'auto' | 'manual'`
- `Level` 新增可選欄位：`phaseMode?: 'auto' | 'manual'`、`leakageEvents?: LeakageEvent[]`
- 新失敗類型 `"neutral-burned"` 和 `"leakage"` 加入 `SimulationStatus`（或獨立失敗原因欄位）
- 現有 `SimulationStatus` 四態維持不變，新增失敗原因由 result 層面處理


## 7. 後續版本方向（Roadmap Preview）

- **v0.5**：整線系統與美觀評分、老屋驚魂模式
- **v1.0**：弱電箱與網路系統模擬
