# PRD v0.6 — Project Rewire（配電盤燒線 Demo / 整線美學版）

## 0. 版本摘要

v0.6 建立在 v0.5 已完成的基礎上（20 關、10 電器、6 線材、壓接端子、三星評分、老屋驚魂前導），聚焦一個方向：
1. **整線美學系統（FR-H）** — 新增「配線美觀度」維度，引入配電箱內部視圖、配線路徑排列、束帶工具與整線評分，讓玩家理解「不只是選對線、壓好端子，走線整齊也是專業電工的基本功」

> v0.1–v0.5 所有功能需求維持不變，本文件僅描述 **增量（delta）** 內容。


## 1. 產品目標（This release）

在 v0.5 的基礎上：
1. 引入配線美學作為新的專業度維度，讓玩家體驗「整線」這項真實電工技能
2. 新增配電箱內部視圖（Panel Interior View），展示匯流排→NFB 的走線佈局
3. 車道排列謎題：玩家拖曳調整走線順序以消除交叉
4. 束帶工具讓玩家學習線路整理的基本概念
5. 整線評分提供量化回饋，與三星系統整合

### 非目標（Not in v0.6）
- 不做自由繪圖式走線（太 CAD 化，保持遊戲節奏）
- 不做線標（wire label）系統
- 不做整線對電氣功能的影響（純評分，不影響模擬）
- 不做完整老屋驚魂模式（延至 v0.7）
- 不做弱電 / 網路


## 2. 功能需求（Functional Requirements）

### FR-H：整線美學系統（Wire Routing & Aesthetics System）

配電箱不只要「接對線」，還要「走得漂亮」。整齊的配線 = 專業 + 安全 + 好維護。

#### 配電箱內部視圖（Panel Interior View）

新增全幅 SVG 元件 `PanelInteriorView`，展示配電箱內部的真實佈局：

```
┌──────────────────────────────────────────────┐
│              主開關 [50A]                      │
│                                               │
│  R ════════════════════════════════════ R      │  ← 匯流排（水平銅排）
│  T ════════════════════════════════════ T      │
│  N ════════════════════════════════════ N      │
│       │    │    │    │    │                    │
│       │    │    │    │    │    ← 配線區        │  ← 走線路徑（垂直車道）
│       │    │    │    │    │                    │
│      [C1] [C2] [C3] [C4] [C5]                │  ← NFB（DIN 軌道）
│       │    │    │    │    │                    │
│       ▼    ▼    ▼    ▼    ▼     ← 出線        │
└──────────────────────────────────────────────┘
```

**配線區**是玩家互動的核心區域：
- 匯流排上方有 R（紅相）、T（黑相）、N（中性線）三條水平銅排
- 每條迴路的線材從匯流排垂直往下連接到對應 NFB
- 線材在配線區佔據一個**車道（lane）**
- 車道順序可拖曳調整
- 交叉自動偵測並以紅色標示

**匯流排連接拓撲：**
- R 相匯流排在左側有分接點（tap）
- T 相匯流排在右側有分接點
- N 中性匯流排在中間
- 110V R 相迴路的線材從左側出發
- 110V T 相迴路的線材從右側出發
- 220V 迴路的線材跨接 R-T，從中間出發

此拓撲自然產生走線謎題：若 R 相迴路的 NFB 在右側、T 相迴路的 NFB 在左側，必然產生交叉，除非玩家重新排列車道順序。


#### 配線路徑排列（Wire Lane Assignment）

**核心機制：排列謎題**

配線區有 N 個車道（= 迴路數量）。每條迴路的線材從匯流排某位置出發，需到達特定 NFB。車道的排列順序決定了是否產生交叉：

- 線材 A 在車道 2，連接到 NFB 位置 3
- 線材 B 在車道 3，連接到 NFB 位置 2
- → A 和 B 的路徑交叉！

玩家透過**拖曳線材左右移動**來重新排列車道順序，目標是最小化交叉數。

**交叉判定演算法：**
對任意兩條線材 i, j：若車道位置 lane[i] < lane[j] 但 NFB 位置 nfb[i] > nfb[j]（或反之），則產生一個交叉。這等同於計算排列的**逆序數（inversion count）**。

**設計決策：**
- 每條線材代表一個迴路的完整配線束（含火線+中性線），不分開個別導線
- 220V 迴路的線束視覺上較粗（雙火線）
- 線材顏色與現有 CircuitDiagram 一致（依線徑：1.6 藍/2.0 綠/3.5 黃/5.5 橘/8.0 紅/14 紫）
- 預設排列 = 迴路定義順序（c1, c2, c3...），通常不是最佳排列
- NFB 位置固定不可調（真實配電箱 NFB 已裝好）


#### 束帶工具（Cable Tie Tool）

束帶用於固定相鄰的平行線材，提升整線評分。

**束帶規則：**
- 束帶可放在任意兩條**相鄰車道**的線材之間
- 被束帶固定的線材必須是**平行的**（不交叉）
- 每對相鄰線材最多放一條束帶
- 束帶免費（同壓接端子設計哲學——聚焦操作技能而非成本取捨）

**互動方式：**
- 配線區每對相鄰車道之間有一個**束帶放置點**（可點擊區域）
- 點擊放置點 → 出現束帶圖示（帶環繞兩條線的束帶）
- 再次點擊 → 移除束帶
- 若兩條線交叉 → 放置點 disabled（交叉的線無法束帶）


#### 整線評分（Aesthetics Score）

整線評分為 0–100 分，基於兩個指標：

```
aestheticsScore = 100 - (crossings × CROSSING_PENALTY) - (unbundledPairs × UNBUNDLED_PENALTY)
aestheticsScore = clamp(0, 100, aestheticsScore)
```

| 指標 | 扣分 | 說明 |
|------|------|------|
| 交叉數（crossings） | −20 / 交叉 | 每個走線交叉扣 20 分 |
| 未束帶平行對（unbundledPairs） | −5 / 對 | 相鄰且平行但未用束帶固定的線對 |

**計分範例（5 迴路，4 對相鄰線）：**

| 情境 | 交叉 | 未束帶 | 分數 |
|------|------|--------|------|
| 完美整線 | 0 | 0 | 100 |
| 全排好，忘束帶 | 0 | 4 | 80 |
| 1 交叉 + 全束帶 | 1 | 0 | 80 |
| 2 交叉 + 2 未束帶 | 2 | 2 | 50 |
| 完全沒整 | 3 | 4 | 20 |

**設計決策：**
- 整線評分**不影響電氣模擬**（不增加熱度、不觸發跳脫）
- 整線評分僅用於三星評等的第三顆星（BonusCondition）
- ResultPanel 顯示整線分數作為回饋


#### 遊戲流程整合

**新增整線階段：**

```
選線 → 接線(拖曳) → [壓接] → [相位/ELCB] → 【整線】→ 送電 → 存活
                                                 ↑ NEW
```

- `Level.requiresRouting: boolean` 控制是否啟用整線階段
- L01–L20：`requiresRouting` 未設定（false），完全不受影響
- L21+：`requiresRouting: true`
- 整線階段**無計時壓力**（計時器在送電後才啟動），讓玩家專心學習整線

**UI 流程：**
1. 所有迴路接線完成（+ 壓接完成 if requiresCrimp）後，出現「整線」按鈕
2. 點擊「整線」→ 開啟配電箱內部視圖（全幅 overlay）
3. 拖曳排列車道 + 放置束帶
4. 左下角即時顯示整線分數
5. 點擊「完成整線」→ 關閉 overlay，回到主畫面
6. 送電時使用最終整線分數計算星等

**送電前置條件更新：**
- 所有迴路已接線 ✓
- 所有壓接完成（若 requiresCrimp）✓
- 所有問題已修復（若 oldHouse）✓
- 已完成整線（若 requiresRouting）✓ ← NEW

「已完成整線」= 玩家至少開啟過整線視圖並點擊「完成整線」。不要求最低分數（分數只影響星等）。


#### 視覺呈現

**配電箱外殼：**
- 金屬質感背景（深灰 #1a1d23 + 微光澤 linear-gradient）
- 外框圓角矩形，左上角螺絲裝飾
- 頂部標示品牌 / 型號文字（裝飾性）

**匯流排區域：**
- 三條水平銅排：R 相紅色(#ef4444)標籤、T 相深色(#1a1a2e)標籤、N 白色(#e8ecf0)標籤
- 銅排顏色 #d97706（銅色）+ 金屬光澤
- 各迴路分接點以小圓點標示

**走線區域：**
- 車道間距明確（≥ 40px），方便觸控拖曳
- 線材顏色 = 現有線徑色系
- 線材粗細：一般迴路 4px，220V 迴路 6px
- 交叉處：紅色高亮 + 小叉叉圖示
- 平行且已束帶：綠色束帶圖示環繞
- 平行未束帶：淡黃色虛線提示（暗示可放束帶）

**NFB 區域：**
- DIN 軌道銀色水平線
- NFB 迷你圖示（矩形 + 規格文字如「20A」）
- 迴路標籤在 NFB 下方

**動畫：**
- 拖曳車道：平滑滑動（CSS transition），其他車道自動讓位
- 放置束帶：束帶收緊動畫（scale 0→1 + rotate）
- 交叉出現/消失：淡入淡出
- 分數變化：數字跳動 + 顏色（綠=好/黃=普通/紅=差）

**響應式：**
- 桌面：overlay 寬 80%，高度自適應
- 平板：overlay 寬 90%
- 手機：overlay 全螢幕，車道間距加大方便觸控


#### 拖曳互動設計

沿用現有 Pointer Events 模式（與 WireSelector 一致）：

- `pointerdown` 在線材上 → 設定 capture
- 水平移動超過閾值 → 開始拖曳
- 拖曳中即時更新車道位置（snap to nearest lane）
- `pointerup` → 確認新位置
- 觸控長按不需要（線材本身就是 drag handle）


#### 與三星評分整合

新增 BonusCondition 類型：

| 類型 | 參數 | 說明 |
|------|------|------|
| `aesthetics-score` | `minScore: number` | 整線分數 ≥ 指定分數 |

L21–L23 的三星第三顆星使用 `aesthetics-score` 條件。

**`calcStars` 擴充：**
- 新增參數：`aestheticsScore?: number`
- 當 bonusCondition.type === 'aesthetics-score' 時，檢查 aestheticsScore >= minScore


**驗收條件：**
- requiresRouting 關卡中，接線完成後出現「整線」按鈕
- 配電箱內部視圖正確顯示匯流排、走線區、NFBs
- 車道拖曳順暢，交叉偵測正確即時更新
- 束帶放置/移除正確，交叉車道不可束帶
- 整線分數即時更新且計算正確
- ResultPanel 顯示整線分數
- 整線分數正確影響三星評等
- L01–L20 不受任何影響


## 3. 更新後的完整數據表

### 線材（6 種，不變）

（同 v0.5）

### 電器（10 種，不變）

（同 v0.5）

### 壓接端子（2 種，不變）

（同 v0.5）

### 整線評分參數（新增）

| 參數 | 值 | 說明 |
|------|------|------|
| `CROSSING_PENALTY` | 20 | 每個交叉扣分 |
| `UNBUNDLED_PENALTY` | 5 | 每對未束帶平行線扣分 |
| `MAX_AESTHETICS_SCORE` | 100 | 滿分 |
| `MIN_AESTHETICS_SCORE` | 0 | 最低分 |


## 4. 新關卡設計（L21–L23）

### L21 整線入門
- **電器**：吹風機 (1200W/110V) + 冰箱 (200W/110V) + 廚下加熱器 (800W/110V)
- **預算**：$150
- **存活時間**：10 秒
- **requiresCrimp**：true
- **requiresRouting**：true
- **迴路配置**：
  - c1「客廳」110V / 20A NFB / R 相 — 可用：吹風機
  - c2「廚房」110V / 20A NFB / T 相 — 可用：廚下加熱器
  - c3「儲藏室」110V / 15A NFB / R 相 — 可用：冰箱
- **相位模式**：auto
- **設計意圖**：首次整線體驗。3 迴路，電流都不高，選線壓力低。重點在學習配電箱內部視圖、車道排列、束帶放置。預設排列（c1-R, c2-T, c3-R）產生 1 個交叉（c2-T 從右側出發但在中間車道，c3-R 從左側出發但在右車道），重新排列為 [c1, c3, c2] 即可消除所有交叉
- **整線分析**：3 車道、最佳 = 0 交叉 + 2 束帶 = 100 分
- **正確策略**：c1 用 2.0mm²、c2 用 2.0mm²、c3 用 1.6mm²（或全 2.0mm²），壓接，整線排列 [c1, c3, c2] + 全束帶
- **成本**：2.0($50) + 2.0($50) + 1.6($30) = $130 ≤ $150 ✓
- **第三星**：`{ type: 'aesthetics-score', minScore: 90 }`

### L22 交叉迷宮
- **電器**：快煮壺 (1500W/110V) + 微波爐 (1100W/110V) + 吹風機 (1200W/110V) + 冰箱 (200W/110V) + 烘衣機 (2200W/220V)
- **預算**：$300
- **存活時間**：12 秒
- **requiresCrimp**：true
- **requiresRouting**：true
- **相位模式**：manual
- **迴路配置**：
  - c1「廚房」110V / 20A NFB / 預設 R 相 — 可用：快煮壺、微波爐
  - c2「客廳」110V / 20A NFB / 預設 T 相 — 可用：吹風機
  - c3「儲藏室」110V / 15A NFB / 預設 R 相 — 可用：冰箱
  - c4「陽台」220V / 20A NFB — 可用：烘衣機
  - c5「備用」110V / 15A NFB / 預設 T 相 — 可用：冰箱
- **設計意圖**：5 迴路 + 混合電壓 + 手動相位。車道多了，交叉更難避免。220V 線束較粗佔據視覺空間。相位分配與走線排列互相影響——切換相位會改變走線的起點側，可能消除或新增交叉。玩家需同時考慮相位平衡與整線效率
- **整線分析**：5 車道、4 對相鄰線、最佳排列取決於最終相位分配
- **正確策略**：c1 用 3.5mm²（快煮壺+微波 23.6A），其餘 2.0/1.6mm²。手動分配相位使 R/T 平衡且走線順暢。整線排列使同相迴路集中
- **成本**：3.5($80) + 2.0($50) + 1.6($30) + 2.0($50) + 1.6($30) = $240 ≤ $300 ✓
- **第三星**：`{ type: 'aesthetics-score', minScore: 80 }`

### L23 完美配電箱
- **電器**：快煮壺 (1500W/110V) + 微波爐 (1100W/110V) + 吹風機 (1200W/110V) + 冰箱 (200W/110V) + 冷氣 (2800W/220V) + 浴室暖風機 (1650W/220V)
- **預算**：$400
- **存活時間**：15 秒
- **requiresCrimp**：true
- **requiresRouting**：true
- **相位模式**：manual
- **漏電模式**：random
- **迴路配置**：
  - c1「廚房」110V / 20A NFB / 預設 R 相 — 可用：快煮壺、微波爐
  - c2「客廳」110V / 20A NFB / 預設 R 相 — 可用：吹風機
  - c3「儲藏室」110V / 15A NFB / 預設 T 相 — 可用：冰箱
  - c4「客廳冷氣」220V / 20A NFB — 可用：冷氣
  - c5「浴室」220V / 20A NFB / **wetArea** / ELCB 可用 — 可用：浴室暖風機
  - c6「備用」110V / 15A NFB / 預設 T 相 — 可用：冰箱
- **設計意圖**：v0.6 畢業考。6 迴路 + 混合電壓 + 手動相位 + ELCB + 壓接 + 整線 = 全機制綜合。6 車道走線挑戰最高（最多可能 15 個交叉），完美排列需仔細規劃。浴室 wetArea 強制 ELCB。相位要平衡（c1+c2 預設全 R，需切 c2 到 T）
- **整線分析**：6 車道、5 對相鄰線、完美排列需將 R 相集中左側、T 相集中右側、220V 放中間
- **相位分析**：c1(R) 快煮壺 13.6A + c2(→T) 吹風機 10.9A → I_N = |13.6 − 10.9| = 2.7A ✓
- **正確策略**：正確選線 + 壓接 + 切相(c2→T) + ELCB(c5) + 整線排列 [R 相, 220V, T 相] 分群
- **成本**：3.5($80) + 2.0($50) + 1.6($30) + 2.0($50) + 2.0($50) + 1.6($30) = $290 + ELCB($35) = $325 ≤ $400 ✓
- **第三星**：`{ type: 'aesthetics-score', minScore: 70 }`


## 5. 關鍵設計決策摘要

| 決策 | 選擇 | 理由 |
|------|------|------|
| 走線排列模型 | 車道排序 + 逆序數偵測 | 直覺、可視化好、數學優雅 |
| 線材以迴路為單位 | 不分個別導線 | 簡化互動，避免過度複雜 |
| 束帶免費 | 與端子一致 | 聚焦操作技能而非成本取捨 |
| 整線不影響電氣功能 | 純評分 | v0.6 先建立概念，降低學習負擔 |
| 整線階段無計時 | 送電前、不壓時間 | 新機制需要學習空間 |
| 配電箱內部為 overlay | 全幅 SVG 視圖 | 足夠空間展示走線，不干擾主畫面 |
| 匯流排拓撲決定起點 | R 左 / T 右 / 220V 中 | 自然產生相位×走線的設計交互 |
| 交叉扣分 20 | 嚴厲 | 讓玩家重視交叉問題 |
| 未束帶扣分 5 | 輕微 | 束帶是加分項，非硬性要求 |
| 完成整線 = 開啟過即可 | 不要求最低分 | 送電門檻不擋玩家，分數只影響星等 |
| 新關卡 3 關 | L21–L23 | 新機制入門 + 進階 + 綜合，節奏適當 |


## 6. 向後相容性

- L01–L20 不受影響：無 `requiresRouting`、原有 bonusCondition 不變
- `Level` 新增可選欄位：`requiresRouting?: boolean`
- `BonusCondition` 新增類型：`{ type: 'aesthetics-score', minScore: number }`
- 新增引擎檔案 `src/engine/aesthetics.ts`（獨立模組，不改既有引擎）
- 新增元件 `src/components/PanelInteriorView.tsx`（獨立元件）
- `GameBoard.tsx` 新增 routing phase 狀態管理（circuitLanes, cableTies, routingCompleted）
- `ResultPanel.tsx` 新增整線分數顯示區塊
- `scoring.ts` 擴充 `calcStars` 支援 `aesthetics-score` condition


## 7. 實作順序

| 順序 | Change 名稱 | 範圍 | 依賴 |
|------|------------|------|------|
| 1 | `panel-interior-view` | PanelInteriorView 元件 + 匯流排/NFB/走線區 SVG 繪製 + 車道拖曳互動 + 響應式 | 無 |
| 2 | `wire-routing-aesthetics` | 束帶工具 UI + 交叉偵測演算法 + 整線評分引擎(aesthetics.ts) + GameBoard 整線流程整合 + ResultPanel 分數顯示 | Change 1 |
| 3 | `routing-levels` | L21–L23 關卡定義 + BonusCondition `aesthetics-score` + calcStars 擴充 + Level 型別擴充 | Change 2 |


## 8. 後續版本方向（Roadmap Preview）

- **v0.7**：完整老屋驚魂模式（FR-I — 更多問題類型 + 隨機老屋生成 + Before/After 對比）
- **v0.8**：整線進階（線標系統 + 整線影響電氣功能 + 更多走線工具）
- **v1.0**：弱電箱與網路系統模擬
